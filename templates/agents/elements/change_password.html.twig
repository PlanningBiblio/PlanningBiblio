{# agents/elements/change_password.html.twig #}
  <style>
    .password-input {
      position: absolute;
      left: 300px;
    }
    .password-error {
      color: red;
      display: none;
    }
  </style>
  <script type='text/JavaScript'>
    function save_password(password) {

      var _token = $('input[name=_token]').val();

      {% if change_own_password == false %}
        var agent_id = $('input[name="id"]').val();
      {% endif %}
      $.ajax({
        {% if change_own_password == true %}
            url: url('ajax/change-own-password'),
        {% else %}
            url: url('ajax/change-password'),
        {% endif %}
        type: "POST",
        dataType: "html",
        {% if change_own_password == true %}
            data: {_token: _token, password: password, current_password: current_password},
        {% else %}
            data: {_token: _token, password: password, id: agent_id},
        {% endif %}
        success: function(){
            $("#reset-password-form").dialog( "close" );
        },
        error: function(xhr, ajaxOptions, thrownError){
          alert("Erreur lors de la modification du mot de passe");
        }
      });
    }

    function clean_on_close() {
        hide_all_password_errors();
        empty_password_fields();
    }

    function hide_all_password_errors() {
        $('#wrong-current-password').hide();
        $('#password-dont-match').hide();
        $('#password-empty').hide();
        $('#password-too-weak').hide();
        $('#password-check-error').hide();
        $('#current-password-check-error').hide();
    }

    function empty_password_fields() {
        $('#new_password').val('');
        $('#confirm_new_password').val('');
        {% if change_own_password == true %}
            $('#current_password').val('');
        {% endif %}
    }

    $(document).ready(function(){
      $("#reset-password-form").dialog({
        autoOpen: false,
        height: 320,
        width: 580,
        modal: true,
        close: clean_on_close,
        buttons: {
          Enregistrer: function() {
            hide_all_password_errors();
            password = $('#new_password').val();
            confirm_password = $('#confirm_new_password').val();
            current_password = $('#current_password').val();
            password_check = false;
            is_current_password = -1; // Current password check is not needed

            {% if change_own_password == true %}
                is_current_password = 0;
                $.ajax({
                    url: url('ajax/is-current-password'),
                    type: "POST",
                    dataType: "html",
                    async: false,
                    data: {password: current_password},
                    success: function(result){
                        if (result == "1") {
                            is_current_password = 1;
                        } else {
                            $('#wrong-current-password').show();
                        }
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                      $('#current-password-check-error').show();
                    }
                });
            {% endif %}

            $.ajax({
                url: url('ajax/check-password'),
                type: "POST",
                dataType: "html",
                async: false,
                data: {password: password},
                success: function(result){
                    if (result == "ok") {
                        password_check = true;
                    } else {
                        $('#password-too-weak').show();
                    }
                },
                error: function(xhr, ajaxOptions, thrownError){
                  $('#password-check-error').show();
                }
              });


            if (password != confirm_password) {
              $('#password-dont-match').show();
            }
            else if (password == '') {
              $('#password-empty').show();
            } else if (password_check == true && is_current_password != 0) {
              save_password(password);
            }
          },
          Annuler: function() {
            $(this).dialog( "close" );
          },
        },
      });

      $('#change-password-link').on('click', function() {
        $("#reset-password-form").dialog( "open" );
      });

    });
  </script>

